(ns worker.slack
  (:require [https :refer [get]]
            [goog.uri.utils :as uri]
            [data.core :as data]))

(defn ->string
  [payload]
  (if (string? payload)
    payload
    (.stringify js/JSON (clj->js payload))))

(defn query
  [params]
  (->> params
       (reduce-kv #(assoc %1 %2 (->string %3)) {})
       clj->js
       (uri/appendParamsFromMap "")))

(defn url
  [action params]
  (-> "https://slack.com/api/"
      (str action)
      (str (query params))))

(defn request
  [action params]
  (get (url action params)))

(defn update-profile
  [text emoji]
  (let [settings (data/read)]
    (when-let [token (:token settings)]
      (request "users.profile.set" {:profile {:status_text  text
                                              :status_emoji emoji}
                                    :token   token}))))

(defn start-pomodoro
  [event id]
  (update-profile "pom party" ":tomato:"))

(defn stop-pomodoro
  [event id]
  (update-profile "\"\"" "\"\""))
